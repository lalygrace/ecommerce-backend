generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SELLER
  CUSTOMER
}

enum SellerStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DRAFT
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  WALLET
  COD
  BANK_TRANSFER
}

enum CouponType {
  PERCENTAGE
  FIXED
  FREE_SHIPPING
}

enum ReservationStatus {
  ACTIVE
  EXPIRED
  CONSUMED
}

enum SettlementStatus {
  PENDING
  READY
  PAID
}

// Recommended: store money as integer cents for precision

model User {
  id            String         @id @default(uuid()) @db.Uuid
  email         String         @unique
  passwordHash  String
  role          UserRole
  name          String?
  phone         String?
  sellerProfile SellerProfile?
  addresses     Address[]
  orders        Order[]        @relation("OrdersByCustomer")
  reviews       Review[]
  notifications Notification[]
  carts         Cart[]
  auditLogs     AuditLog[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([role])
  @@index([email])
}

model SellerProfile {
  id          String       @id @default(uuid()) @db.Uuid
  userId      String       @unique @db.Uuid
  user        User         @relation(fields: [userId], references: [id])
  displayName String
  slug        String       @unique
  about       String?
  status      SellerStatus @default(PENDING)
  vendor      Vendor?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([slug])
  @@index([status])
}

model Vendor {
  id          String        @id @default(uuid()) @db.Uuid
  sellerId    String        @unique @db.Uuid
  seller      SellerProfile @relation(fields: [sellerId], references: [id])
  name        String
  slug        String        @unique
  description String?
  logoUrl     String?
  products    Product[]
  settlements VendorSettlement[]
  payouts     VendorPayout[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([slug])
}

model Category {
  id        String     @id @default(uuid()) @db.Uuid
  name      String
  slug      String     @unique
  parentId  String? @db.Uuid
  parent    Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryParent")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([parentId])
  @@index([slug])
}

model Product {
  id                 String        @id @default(uuid()) @db.Uuid
  vendorId           String @db.Uuid
  vendor             Vendor        @relation(fields: [vendorId], references: [id])
  title              String
  slug               String        @unique
  description        String?
  priceCents         Int
  originalPriceCents Int?
  stock              Int
  shippingFeeCents   Int?
  deliveryTime       String?
  rating             Float?
  reviewCount        Int           @default(0)
  image              String?
  images             String[]
  categorySlugs      String[]      // use slugs from Category for simplicity
  status             ProductStatus @default(ACTIVE)
  variants           ProductVariant[]
  reviews            Review[]
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([vendorId])
  @@index([status])
  @@index([slug])
}

model ProductVariant {
  id                 String   @id @default(uuid()) @db.Uuid
  productId          String @db.Uuid
  product            Product  @relation(fields: [productId], references: [id])
  sku                String   @unique
  size               String?
  color              String?
  priceOverrideCents Int?
  stock              Int       @default(0)
  image              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([productId])
  @@index([sku])
}

model Review {
  id        String   @id @default(uuid()) @db.Uuid
  productId String @db.Uuid
  product   Product  @relation(fields: [productId], references: [id])
  userId    String @db.Uuid
  user      User     @relation(fields: [userId], references: [id])
  rating    Int
  title     String?
  body      String?
  helpfulCount Int   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([userId])
  @@index([rating])
}

model OrderItem {
  id             String @id @default(uuid()) @db.Uuid
  orderId        String @db.Uuid
  order          Order  @relation(fields: [orderId], references: [id])
  productId      String @db.Uuid
  vendorId       String @db.Uuid
  title          String
  unitPriceCents Int
  quantity       Int
  image          String?
  variantSku     String?
}

model Order {
  id             String       @id @default(uuid()) @db.Uuid
  customerId     String @db.Uuid
  customer       User         @relation("OrdersByCustomer", fields: [customerId], references: [id])
  items          OrderItem[]
  totalCents     Int
  status         OrderStatus  @default(PENDING)
  payment        Payment?
  shippingAddress Json?        // snapshot of address at time of order
  couponCode     String?
  discountTotalCents Int?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  settlements    VendorSettlement[]

  @@index([customerId])
  @@index([status])
  @@index([couponCode])
}

model Payment {
  id             String        @id @default(uuid()) @db.Uuid
  orderId        String        @unique @db.Uuid
  order          Order         @relation(fields: [orderId], references: [id])
  method         PaymentMethod
  amountCents    Int
  currency       String        @default("USD")
  status         PaymentStatus @default(PENDING)
  gateway        String?
  transactionRef String?
  errorMessage   String?
  capturedAt     DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([status])
}

model CartItem {
  id             String @id @default(uuid()) @db.Uuid
  cartId         String @db.Uuid
  cart           Cart   @relation(fields: [cartId], references: [id])
  productId      String @db.Uuid
  title          String
  unitPriceCents Int
  quantity       Int
  image          String?
  variantSku     String?
}

model Cart {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String @db.Uuid
  user      User      @relation(fields: [userId], references: [id])
  sessionId String?
  items     CartItem[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([userId])
  @@index([sessionId])
}

model Coupon {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique
  type        CouponType
  valueCents  Int
  maxUses     Int?
  usedCount   Int      @default(0)
  validFrom   DateTime?
  validTo     DateTime?
  active      Boolean  @default(true)
  minOrderAmountCents Int?
  applicableCategorySlugs String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([active])
  @@index([validFrom, validTo])
}

model Address {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String @db.Uuid
  user       User     @relation(fields: [userId], references: [id])
  label      String?
  name       String?
  line1      String
  line2      String?
  city       String
  state      String?
  postalCode String
  country    String
  phone      String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([isDefault])
}

model Notification {
  id        String     @id @default(uuid()) @db.Uuid
  userId    String @db.Uuid
  user      User       @relation(fields: [userId], references: [id])
  type      String
  message   String
  readAt    DateTime?
  ip        String?
  userAgent String?
  category  String?
  createdAt DateTime   @default(now())

  @@index([userId])
  @@index([readAt])
}

model InventoryEvent {
  id          String   @id @default(uuid()) @db.Uuid
  productId   String @db.Uuid
  variantSku  String?
  type        String   // ADJUST, SALE, RETURN, RESERVE, RELEASE
  quantity    Int
  note        String?
  createdAt   DateTime @default(now())

  @@index([productId])
  @@index([variantSku])
  @@index([type])
}

model Reservation {
  id          String            @id @default(uuid()) @db.Uuid
  productId   String @db.Uuid
  variantSku  String?
  userId      String? @db.Uuid
  sessionId   String?
  quantity    Int
  status      ReservationStatus @default(ACTIVE)
  expiresAt   DateTime
  createdAt   DateTime          @default(now())

  @@index([productId])
  @@index([expiresAt])
  @@index([userId])
  @@index([sessionId])
}

model VendorSettlement {
  id             String          @id @default(uuid()) @db.Uuid
  orderId        String @db.Uuid
  order          Order           @relation(fields: [orderId], references: [id])
  vendorId       String @db.Uuid
  vendor         Vendor          @relation(fields: [vendorId], references: [id])
  grossCents     Int
  commissionCents Int
  netCents       Int
  status         SettlementStatus @default(PENDING)
  payoutId       String? @db.Uuid
  payout         VendorPayout?   @relation(fields: [payoutId], references: [id])
  createdAt      DateTime        @default(now())

  @@index([orderId])
  @@index([vendorId])
  @@index([status])
}

model VendorPayout {
  id          String     @id @default(uuid()) @db.Uuid
  vendorId    String @db.Uuid
  vendor      Vendor     @relation(fields: [vendorId], references: [id])
  amountCents Int
  currency    String     @default("USD")
  status      String     @default("PENDING")
  scheduledAt DateTime?
  paidAt      DateTime?
  transferRef String?
  createdAt   DateTime   @default(now())

  settlements VendorSettlement[]

  @@index([vendorId])
  @@index([status])
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  actorId   String? @db.Uuid
  actor     User?    @relation(fields: [actorId], references: [id])
  action    String
  target    String?
  meta      Json?
  ip        String?
  userAgent String?
  category  String?
  createdAt DateTime  @default(now())

  @@index([actorId])
  @@index([action])
  @@index([target])
}
